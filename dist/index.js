!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("zen-observable")):"function"==typeof define&&define.amd?define(["exports","zen-observable"],t):t(r.effectjs=r.effectjs||{},r.Observable)}(this,function(r,t){"use strict";function e(r){return r[S]===!0?r:O(i,r)}t="default"in t?t["default"]:t;var n="none",o="apply",f="all",i="create",u=function(r,t,e){return t in r?Object.defineProperty(r,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[t]=e,r},a=function(){function r(r,t){var e=[],n=!0,o=!1,f=void 0;try{for(var i,u=r[Symbol.iterator]();!(n=(i=u.next()).done)&&(e.push(i.value),!t||e.length!==t);n=!0);}catch(a){o=!0,f=a}finally{try{!n&&u["return"]&&u["return"]()}finally{if(o)throw f}}return e}return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return r(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),c=function(r){return 0===r.length?r:r.reduce(function(r,t){return t.forEach(function(t){return r.push(t)}),r},[])},s=function(r){return void 0!==r&&null!==r},p=function(r){return Array.isArray(r)?r:[r]},l=function(){var r;return r={},u(r,i,function(r,t){return Promise.resolve([r])}),u(r,n,function(r,t){return Promise.resolve([])}),u(r,o,function(r,t){var e=r.f,n=r.x;return Promise.all([t(e),t(n)]).then(function(r){var t=a(r,2),e=t[0],n=t[1],o=[];return e.forEach(function(r){return n.forEach(function(t){return o.push(r(t))})}),o})}),u(r,f,function(r,t){var e=r.effects,o=e.filter(function(r){return s(r)&&r.type!==n});return 0===o.length?Promise.resolve([]):Promise.all(o.map(t)).then(c)}),r},v=function(r){return u({},r.type,r.performer)},y=function(){for(var r=arguments.length,t=Array(r),e=0;r>e;e++)t[e]=arguments[e];return h.apply(void 0,[l].concat(t,[v]))},d=function(r){return function(t){return t(r)}},h=function W(){for(var r=arguments.length,t=Array(r),e=0;r>e;e++)t[e]=arguments[e];return function(r){var e=r.type,n=t.map(d(r)),o=n.find(function(r){return s(r[e])});if(o){var f=r.data,i=o[e],u=W.apply(void 0,t),a=i(f,u);return Promise.resolve(a).then(p)}return Promise.reject(new Error("No performer for type "+e+", "+String(r)+", "+JSON.stringify(n)))}},m=void 0,b=function(r){var t=r.type,e=r.data,i=t;if(t===n)return"[Effect "+i+"]";if(t===o){var u=e.f,a=e.x;return i+"("+u+", "+a+")"}if(t===f){var c=e.effects,s=c.map(String).join(", ");return i+"(["+s+"])"}var p=e&&e.name?e.name:String(e);return i+"("+p+")"},g=function(r){var t=r.type,e=r.data;if(e){var n=e.action;if(n)return"Action("+t+", "+n+")";var o=String(e);return"[object Object]"===o&&(o=JSON.stringify(e)),"Action("+t+", "+o+")"}return"Action("+t+")"},E=function(r){var t=m.state,e=m.effect,n=JSON.stringify(t);return e.type===effectTypes.none?"Result("+n+")":"Result("+n+", "+e+")"},S=Symbol("SideEffect"),w={map:function(r){var t=A(e(r),this);return t},toString:function(){return b(this)}},j=function(r){if(!Array.isArray(r))throw new Error("Need to pass array to Effects.all, got: "+JSON.stringify(r));if(0===r.length)return R;if(1===r.length){var t=a(r,1),e=t[0];return e}return O(f,{effects:r})},A=function B(r,t){if(r.type===f){var u=r.data.effects,a=u.map(function(r){return B(r,t)});return j(a)}if(t.type===f){var c=t.data.effects,s=c.map(function(t){return B(r,t)});return j(s)}if(r.type===i){if(t.type===i)return e(r.data(t.data));if(t[S])return O(o,{f:r,x:t});throw new Error("Effects.apply expects both arguments to be Effects, got ("+r+", "+t+").")}if(t.type===i){var p=function(r){return r(t.data)},l=e(p);return B(l,r)}if(r.type===n)return t;if(r[S]&&t[S])return O(o,{f:r,x:t});throw new Error("Effects.apply expects both arguments to be Effects, got ("+r+", "+t+").")},O=function(r,t,e){var n=Object.create(w);return n[S]=!0,Object.assign(n,{type:r,data:t,performer:e})},x=O,P=function(){for(var r=arguments.length,t=Array(r),e=0;r>e;e++)t[e]=arguments[e];return t.reduceRight(function(r,t){return A(t,r)})},N=function(){for(var r=arguments.length,t=Array(r),e=0;r>e;e++)t[e]=arguments[e];return t.reduce(function(r,t){return A(t,r)})},J=N,R=O(n),q=Object.freeze({performWith:h,basePerformer:l,performer:y,SideEffect:S,all:j,apply:A,create:x,compose:P,sequence:N,seq:J,none:R,"default":e}),z=Symbol("result"),T={toString:function(){return E(this)}},V=function(r){var t=arguments.length<=1||void 0===arguments[1]?R:arguments[1],e=Object.create(T);return e.state=r,e.effect=t,e[z]=!0,e},_={toString:function(){return g(this)}},k=function(r,t){var e=Object.create(_);return e.type=r,e.data=t,e},I=function(){},M=function(r){return setTimeout(r,0)},U=function(r){var e=r.init,o=r.update,f=r.view,i=void 0===f?I:f,u=r.performers,a=r.inputs,c=(r.onView,[]),s=[],p=!1,l=void 0,v=u?y(u):y(),d={onView:function(r){c.push(r)},onStart:function(r){p?r(l):s.push(r)},use:function(r,t){r(d,t)},start:function(){var r=void 0,f=new t(function(t){r=t.next.bind(t),a&&"function"==typeof a.forEach&&a.forEach(r)}),u=function(t,e){return v(t).then(function(t){t.forEach(r)})["catch"](function(n){e&&"error"===e.type||r(k("error",{error:n,effect:t,action:e}))})};f.forEach(function(t){var e=t.type,f=o(d,t);if(!f||void 0===f.state){var a=new Error("Unhandled action type "+e+" for action "+t);"error"!==t.type&&r(k("error",{error:a}))}var s=f.state,p=f.effect;d=s,p&&p.type!==n&&u(p,t);var l=i(d,r);c.forEach(function(t){return t(l,r)})})["catch"](function(r){console.error(r),console.error(r.stack)});var y=e(),d=y.state,h=y.effect;l=i(d,r),p=!0,s.forEach(function(r){return r(l)}),s=[],M(function(){u(h)})}};return d};r.App=U,r.Effect=e,r.Effects=q,r.Result=V,r.Action=k,Object.defineProperty(r,"__esModule",{value:!0})});